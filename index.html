<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hichoux Store - Admin Dashboard</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- TailwindCSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        .page { display: none; }
        .page.active { display: block; }
        .sidebar-item { transition: all 0.2s; }
        .sidebar-item.active { background: #dbeafe; color: #2563eb; }
        .sidebar-item:hover:not(.active) { background: #f3f4f6; }
        .toast { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes spin { to { transform: rotate(360deg); } }
        .animate-spin { animation: spin 1s linear infinite; }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Toast Container -->
    <div id="toast-container" class="fixed top-4 right-4 z-[100] space-y-2"></div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-black/50 flex items-center justify-center z-[90] hidden">
        <div class="bg-white rounded-2xl p-8 flex flex-col items-center">
            <div class="w-12 h-12 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mb-4"></div>
            <p id="loading-text">Chargement...</p>
        </div>
    </div>

    <!-- Config Modal -->
    <div id="config-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-[80] p-4">
        <div class="bg-white rounded-2xl w-full max-w-lg p-6 shadow-2xl">
            <div class="flex items-center space-x-3 mb-6">
                <div class="w-12 h-12 bg-blue-600 rounded-xl flex items-center justify-center text-white text-xl font-bold">H</div>
                <div>
                    <h3 class="text-xl font-bold">Hichoux Store Admin</h3>
                    <p class="text-gray-500 text-sm">Configuration</p>
                </div>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-1">Supabase URL *</label>
                    <input type="text" id="config-url" placeholder="https://xxx.supabase.co" class="w-full px-4 py-2.5 border rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Supabase Anon Key *</label>
                    <input type="text" id="config-key" placeholder="eyJhbGciOiJIUzI1NiIs..." class="w-full px-4 py-2.5 border rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Google Apps Script URL</label>
                    <input type="text" id="config-gas" placeholder="https://script.google.com/macros/s/xxx/exec" class="w-full px-4 py-2.5 border rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
            </div>
            
            <div class="bg-blue-50 rounded-xl p-4 mt-4">
                <p class="text-sm text-blue-800">üí° Obtenir ces informations depuis votre <a href="https://supabase.com" target="_blank" class="underline font-medium">dashboard Supabase</a> ‚Üí Settings ‚Üí API</p>
            </div>
            
            <div class="flex space-x-3 mt-6">
                <button onclick="skipConfig()" class="flex-1 px-4 py-2.5 border-2 rounded-xl hover:bg-gray-50 transition font-medium">Mode Demo</button>
                <button onclick="saveConfig()" class="flex-1 px-4 py-2.5 bg-blue-600 text-white rounded-xl hover:bg-blue-700 transition font-medium">Connecter</button>
            </div>
        </div>
    </div>

    <!-- Order Detail Modal -->
    <div id="order-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-[70] p-4 hidden">
        <div class="bg-white rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-hidden flex flex-col shadow-2xl">
            <div class="p-6 border-b flex items-center justify-between">
                <h3 class="text-xl font-bold">Commande <span id="modal-order-id"></span></h3>
                <button onclick="closeOrderModal()" class="p-2 hover:bg-gray-100 rounded-lg transition text-xl">‚úï</button>
            </div>
            <div id="modal-content" class="p-6 overflow-y-auto flex-1"></div>
            <div id="modal-actions" class="p-4 bg-gray-50 border-t flex flex-wrap gap-2 justify-end"></div>
        </div>
    </div>

    <!-- Main Layout -->
    <div class="flex h-screen">
        <!-- Sidebar -->
        <aside class="w-64 bg-white border-r flex flex-col shrink-0">
            <div class="p-6 border-b">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl flex items-center justify-center text-white font-bold shadow-lg">H</div>
                    <div>
                        <h1 class="font-bold text-gray-900">Hichoux Store</h1>
                        <p class="text-xs" id="connection-status"><span class="text-gray-400">‚óè Mode Demo</span></p>
                    </div>
                </div>
            </div>

            <nav class="flex-1 p-4 space-y-1">
                <button onclick="showPage('dashboard')" data-page="dashboard" class="sidebar-item active w-full flex items-center justify-between px-4 py-3 rounded-xl text-sm font-medium text-left">
                    <span class="flex items-center space-x-3"><span>üìä</span><span>Dashboard</span></span>
                </button>
                <button onclick="showPage('orders')" data-page="orders" class="sidebar-item w-full flex items-center justify-between px-4 py-3 rounded-xl text-sm font-medium text-left">
                    <span class="flex items-center space-x-3"><span>üì¶</span><span>Commandes</span></span>
                    <span class="badge-orders bg-red-500 text-white text-xs px-2 py-0.5 rounded-full hidden">0</span>
                </button>
                <button onclick="showPage('confirmation')" data-page="confirmation" class="sidebar-item w-full flex items-center justify-between px-4 py-3 rounded-xl text-sm font-medium text-left">
                    <span class="flex items-center space-x-3"><span>üìû</span><span>Confirmation</span></span>
                    <span class="badge-confirmation bg-red-500 text-white text-xs px-2 py-0.5 rounded-full hidden">0</span>
                </button>
                <button onclick="showPage('shipping')" data-page="shipping" class="sidebar-item w-full flex items-center justify-between px-4 py-3 rounded-xl text-sm font-medium text-left">
                    <span class="flex items-center space-x-3"><span>üè∑Ô∏è</span><span>Shipping Labels</span></span>
                </button>
                <button onclick="showPage('products')" data-page="products" class="sidebar-item w-full flex items-center justify-between px-4 py-3 rounded-xl text-sm font-medium text-left">
                    <span class="flex items-center space-x-3"><span>üõçÔ∏è</span><span>Produits</span></span>
                </button>
                <button onclick="showPage('settings')" data-page="settings" class="sidebar-item w-full flex items-center justify-between px-4 py-3 rounded-xl text-sm font-medium text-left">
                    <span class="flex items-center space-x-3"><span>‚öôÔ∏è</span><span>Param√®tres</span></span>
                </button>
            </nav>

            <div class="p-4 border-t">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 font-semibold">A</div>
                    <div>
                        <p class="text-sm font-medium">Admin</p>
                        <p class="text-xs text-gray-500">Administrateur</p>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 overflow-auto">
            <div class="p-8">
                
                <!-- ==================== DASHBOARD PAGE ==================== -->
                <div id="page-dashboard" class="page active">
                    <div class="flex justify-between items-center mb-6">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-900">Dashboard</h2>
                            <p class="text-gray-500">Vue d'ensemble de votre activit√©</p>
                        </div>
                        <p class="text-sm text-gray-500" id="current-date"></p>
                    </div>

                    <!-- Stats Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8" id="stats-cards">
                        <div class="bg-white rounded-2xl p-6 shadow-sm border">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-gray-500 text-sm">Nouvelles</p>
                                    <p class="text-3xl font-bold mt-1" id="stat-new">0</p>
                                    <p class="text-xs text-gray-400 mt-1">En attente</p>
                                </div>
                                <div class="w-12 h-12 bg-yellow-100 text-yellow-600 rounded-xl flex items-center justify-center text-xl">üì•</div>
                            </div>
                        </div>
                        <div class="bg-white rounded-2xl p-6 shadow-sm border">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-gray-500 text-sm">Confirm√©es</p>
                                    <p class="text-3xl font-bold mt-1" id="stat-confirmed">0</p>
                                    <p class="text-xs text-gray-400 mt-1">Pr√™tes</p>
                                </div>
                                <div class="w-12 h-12 bg-blue-100 text-blue-600 rounded-xl flex items-center justify-center text-xl">‚úì</div>
                            </div>
                        </div>
                        <div class="bg-white rounded-2xl p-6 shadow-sm border">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-gray-500 text-sm">Exp√©di√©es</p>
                                    <p class="text-3xl font-bold mt-1" id="stat-shipped">0</p>
                                    <p class="text-xs text-gray-400 mt-1">En transit</p>
                                </div>
                                <div class="w-12 h-12 bg-purple-100 text-purple-600 rounded-xl flex items-center justify-center text-xl">üöö</div>
                            </div>
                        </div>
                        <div class="bg-white rounded-2xl p-6 shadow-sm border">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-gray-500 text-sm">Livr√©es</p>
                                    <p class="text-3xl font-bold mt-1" id="stat-delivered">0</p>
                                    <p class="text-xs text-green-600 mt-1" id="stat-revenue">0 DH</p>
                                </div>
                                <div class="w-12 h-12 bg-green-100 text-green-600 rounded-xl flex items-center justify-center text-xl">‚úÖ</div>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Orders -->
                    <div class="bg-white rounded-2xl shadow-sm border">
                        <div class="p-6 border-b flex justify-between items-center">
                            <h3 class="font-semibold text-gray-900">Commandes R√©centes</h3>
                            <button onclick="showPage('orders')" class="text-blue-600 text-sm hover:underline">Voir tout ‚Üí</button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase">ID</th>
                                        <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Client</th>
                                        <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Ville</th>
                                        <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Total</th>
                                        <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Statut</th>
                                        <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="recent-orders-table" class="divide-y"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- ==================== ORDERS PAGE ==================== -->
                <div id="page-orders" class="page">
                    <div class="flex justify-between items-center mb-6">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-900">üì¶ Commandes</h2>
                            <p class="text-gray-500">G√©rez toutes vos commandes</p>
                        </div>
                        <button onclick="refreshData()" class="px-4 py-2 bg-blue-600 text-white rounded-xl hover:bg-blue-700 transition flex items-center space-x-2">
                            <span>üîÑ</span><span>Actualiser</span>
                        </button>
                    </div>

                    <!-- Filters -->
                    <div class="flex flex-wrap gap-4 mb-6">
                        <div class="relative flex-1 max-w-md">
                            <svg class="w-5 h-5 absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                            <input type="text" id="search-orders" placeholder="Rechercher par nom, t√©l√©phone, ID..." class="w-full pl-10 pr-4 py-2.5 border rounded-xl focus:ring-2 focus:ring-blue-500" onkeyup="filterOrders()">
                        </div>
                        <select id="filter-status" class="px-4 py-2.5 border rounded-xl bg-white focus:ring-2 focus:ring-blue-500" onchange="filterOrders()">
                            <option value="all">Tous les statuts</option>
                            <option value="new">Nouvelles</option>
                            <option value="confirmed">Confirm√©es</option>
                            <option value="shipped">Exp√©di√©es</option>
                            <option value="delivered">Livr√©es</option>
                            <option value="cancelled">Annul√©es</option>
                        </select>
                    </div>

                    <!-- Orders Table -->
                    <div class="bg-white rounded-2xl shadow-sm border overflow-hidden">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-4 text-left text-xs font-semibold text-gray-500 uppercase">Commande</th>
                                    <th class="px-6 py-4 text-left text-xs font-semibold text-gray-500 uppercase">Client</th>
                                    <th class="px-6 py-4 text-left text-xs font-semibold text-gray-500 uppercase">T√©l√©phone</th>
                                    <th class="px-6 py-4 text-left text-xs font-semibold text-gray-500 uppercase">Ville</th>
                                    <th class="px-6 py-4 text-left text-xs font-semibold text-gray-500 uppercase">Total</th>
                                    <th class="px-6 py-4 text-left text-xs font-semibold text-gray-500 uppercase">Statut</th>
                                    <th class="px-6 py-4 text-left text-xs font-semibold text-gray-500 uppercase">Tracking</th>
                                    <th class="px-6 py-4 text-left text-xs font-semibold text-gray-500 uppercase">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="orders-table" class="divide-y"></tbody>
                        </table>
                    </div>
                </div>

                <!-- ==================== CONFIRMATION PAGE ==================== -->
                <div id="page-confirmation" class="page">
                    <div class="flex justify-between items-center mb-6">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-900">üìû Confirmation</h2>
                            <p class="text-gray-500" id="pending-count">0 commandes en attente</p>
                        </div>
                    </div>

                    <div id="confirmation-list" class="space-y-4"></div>

                    <div id="all-confirmed" class="hidden bg-white rounded-2xl p-12 text-center shadow-sm border">
                        <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4 text-4xl">‚úì</div>
                        <h3 class="text-xl font-semibold text-gray-900">Tout est confirm√© !</h3>
                        <p class="text-gray-500 mt-2">Aucune commande en attente de confirmation</p>
                    </div>
                </div>

                <!-- ==================== SHIPPING PAGE ==================== -->
                <div id="page-shipping" class="page">
                    <div class="flex justify-between items-center mb-6">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-900">üè∑Ô∏è Shipping Labels</h2>
                            <p class="text-gray-500">Bordereaux d'exp√©dition</p>
                        </div>
                        <button onclick="createShippingLabel()" class="px-4 py-2 bg-blue-600 text-white rounded-xl hover:bg-blue-700 transition flex items-center space-x-2">
                            <span>+</span><span>Cr√©er Bordereau</span>
                        </button>
                    </div>

                    <div class="bg-white rounded-2xl shadow-sm border overflow-hidden">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-4 text-left text-xs font-semibold text-gray-500 uppercase">BL ID</th>
                                    <th class="px-6 py-4 text-left text-xs font-semibold text-gray-500 uppercase">Transporteur</th>
                                    <th class="px-6 py-4 text-left text-xs font-semibold text-gray-500 uppercase">Commandes</th>
                                    <th class="px-6 py-4 text-left text-xs font-semibold text-gray-500 uppercase">Montant</th>
                                    <th class="px-6 py-4 text-left text-xs font-semibold text-gray-500 uppercase">Statut</th>
                                    <th class="px-6 py-4 text-left text-xs font-semibold text-gray-500 uppercase">Paiement</th>
                                    <th class="px-6 py-4 text-left text-xs font-semibold text-gray-500 uppercase">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="shipping-table" class="divide-y"></tbody>
                        </table>
                    </div>
                </div>

                <!-- ==================== PRODUCTS PAGE ==================== -->
                <div id="page-products" class="page">
                    <div class="flex justify-between items-center mb-6">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-900">üõçÔ∏è Produits</h2>
                            <p class="text-gray-500" id="products-count">0 produits</p>
                        </div>
                        <button onclick="showToast('Fonctionnalit√© √† venir', 'info')" class="px-4 py-2 bg-blue-600 text-white rounded-xl hover:bg-blue-700 transition flex items-center space-x-2">
                            <span>+</span><span>Ajouter</span>
                        </button>
                    </div>

                    <div class="bg-white rounded-2xl shadow-sm border overflow-hidden">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-4 text-left text-xs font-semibold text-gray-500 uppercase">Produit</th>
                                    <th class="px-6 py-4 text-left text-xs font-semibold text-gray-500 uppercase">SKU</th>
                                    <th class="px-6 py-4 text-left text-xs font-semibold text-gray-500 uppercase">Cat√©gorie</th>
                                    <th class="px-6 py-4 text-left text-xs font-semibold text-gray-500 uppercase">Prix</th>
                                    <th class="px-6 py-4 text-left text-xs font-semibold text-gray-500 uppercase">Stock</th>
                                    <th class="px-6 py-4 text-left text-xs font-semibold text-gray-500 uppercase">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="products-table" class="divide-y"></tbody>
                        </table>
                    </div>
                </div>

                <!-- ==================== SETTINGS PAGE ==================== -->
                <div id="page-settings" class="page">
                    <div class="mb-6">
                        <h2 class="text-2xl font-bold text-gray-900">‚öôÔ∏è Param√®tres</h2>
                        <p class="text-gray-500">Configuration de votre store</p>
                    </div>

                    <div class="bg-white rounded-2xl shadow-sm border overflow-hidden">
                        <div class="p-6 border-b flex items-center space-x-4">
                            <div class="w-16 h-16 bg-blue-600 rounded-2xl flex items-center justify-center text-white text-3xl font-bold">H</div>
                            <div>
                                <h3 class="text-xl font-bold text-gray-900">Hichoux Store</h3>
                                <span class="px-2 py-0.5 bg-blue-100 text-blue-700 text-xs rounded-full">Store</span>
                            </div>
                        </div>

                        <div class="p-6 space-y-6">
                            <!-- Database -->
                            <div class="border-b pb-6">
                                <h4 class="font-semibold text-gray-900 mb-4">üóÑÔ∏è Database (Supabase)</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">URL</label>
                                        <input type="text" id="settings-supabase-url" class="w-full px-4 py-2.5 border rounded-xl bg-gray-50" readonly>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Statut</label>
                                        <p id="settings-supabase-status" class="px-4 py-2.5 bg-gray-100 rounded-xl">Non connect√©</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Google Sheets -->
                            <div class="border-b pb-6">
                                <h4 class="font-semibold text-gray-900 mb-4">üìä Google Sheets</h4>
                                <div class="bg-green-50 border border-green-200 rounded-xl p-4">
                                    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                                        <div>
                                            <p class="font-medium text-green-800">‚úì Sheet Connected</p>
                                            <a href="https://docs.google.com/spreadsheets/d/1qKkOSPisPkqUQEkH-stKoUaEo1d9e63pVcV1iU9yvHw/edit" target="_blank" class="text-blue-600 text-sm hover:underline">Open Sheet ‚Üó</a>
                                            <p class="text-xs text-green-600 mt-1" id="last-sync">Last sync: -</p>
                                        </div>
                                        <button onclick="syncToGoogleSheet()" class="px-4 py-2 bg-teal-500 text-white rounded-xl hover:bg-teal-600 transition">
                                            üîÑ Sync Now
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Digylog -->
                            <div class="border-b pb-6">
                                <h4 class="font-semibold text-gray-900 mb-4">üöö API Digylog</h4>
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Bearer Token</label>
                                        <input type="password" id="digylog-token" placeholder="Votre token API" class="w-full px-4 py-2.5 border rounded-xl">
                                    </div>
                                    <button onclick="showToast('Test en cours...', 'info')" class="px-4 py-2 bg-purple-500 text-white rounded-xl hover:bg-purple-600 transition">
                                        Tester la connexion
                                    </button>
                                </div>
                            </div>

                            <!-- Store Info -->
                            <div>
                                <h4 class="font-semibold text-gray-900 mb-4">üè™ Informations Store</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Nom du Store</label>
                                        <input type="text" id="store-name" value="Hichoux Store" class="w-full px-4 py-2.5 border rounded-xl">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">T√©l√©phone</label>
                                        <input type="text" id="store-phone" value="0600000000" class="w-full px-4 py-2.5 border rounded-xl">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">WhatsApp</label>
                                        <input type="text" id="store-whatsapp" value="212600000000" class="w-full px-4 py-2.5 border rounded-xl">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Frais livraison (DH)</label>
                                        <input type="number" id="shipping-cost" value="30" class="w-full px-4 py-2.5 border rounded-xl">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="p-6 bg-gray-50 border-t flex justify-between items-center">
                            <button onclick="document.getElementById('config-modal').classList.remove('hidden')" class="text-blue-600 hover:underline text-sm">Modifier la configuration</button>
                            <button onclick="saveSettings()" class="px-6 py-2.5 bg-blue-600 text-white rounded-xl hover:bg-blue-700 transition">
                                üíæ Sauvegarder
                            </button>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- JavaScript -->
    <script>
        // =============================================
        // CONFIGURATION
        // =============================================
        const CONFIG = {
            SUPABASE_URL: '',
            SUPABASE_ANON_KEY: '',
            GOOGLE_SCRIPT_URL: '',
            CURRENCY: 'DH'
        };

        // =============================================
        // STATE
        // =============================================
        let orders = [];
        let products = [];
        let shippingLabels = [];
        let supabaseClient = null;

        // Demo Data
        const demoOrders = [
            { id: '1', order_number: 'HCX001234', customer_name: 'Ahmed Benali', customer_phone: '0661234567', shipping_address: 'Rue Hassan II, N¬∞45', shipping_city: 'Casablanca', total: 300, status: 'new', created_at: '2025-11-27T10:00:00', order_items: [{ product_name: 'Parfum Royal Oud', quantity: 2, unit_price: 150 }] },
            { id: '2', order_number: 'HCX001235', customer_name: 'Fatima Zahra', customer_phone: '0677889900', shipping_address: 'Avenue Mohammed V, Appt 12', shipping_city: 'Rabat', total: 200, status: 'new', created_at: '2025-11-27T11:00:00', order_items: [{ product_name: 'Essence de Rose', quantity: 1, unit_price: 200 }] },
            { id: '3', order_number: 'HCX001236', customer_name: 'Youssef Alami', customer_phone: '0655443322', shipping_address: 'Quartier Gueliz', shipping_city: 'Marrakech', total: 360, status: 'new', notes: 'Client VIP', created_at: '2025-11-27T09:00:00', order_items: [{ product_name: 'Amber Nights', quantity: 3, unit_price: 120 }] },
            { id: '4', order_number: 'HCX001237', customer_name: 'Khadija Mansouri', customer_phone: '0688776655', shipping_address: 'Hay Mohammadi', shipping_city: 'Agadir', total: 150, status: 'confirmed', created_at: '2025-11-26T14:00:00', order_items: [{ product_name: 'Parfum Royal Oud', quantity: 1, unit_price: 150 }] },
            { id: '5', order_number: 'HCX001238', customer_name: 'Omar Tazi', customer_phone: '0699887766', shipping_address: 'Centre ville', shipping_city: 'F√®s', total: 360, status: 'confirmed', created_at: '2025-11-26T10:00:00', order_items: [{ product_name: 'Musk Premium', quantity: 2, unit_price: 180 }] },
            { id: '6', order_number: 'HCX001239', customer_name: 'Sara Bennani', customer_phone: '0612345678', shipping_address: 'Hay Riad', shipping_city: 'Rabat', total: 200, status: 'shipped', tracking_number: 'S2AD5795M', created_at: '2025-11-25T10:00:00', order_items: [{ product_name: 'Essence de Rose', quantity: 1, unit_price: 200 }] },
            { id: '7', order_number: 'HCX001240', customer_name: 'Mohammed Idrissi', customer_phone: '0633221100', shipping_address: 'Zone Industrielle', shipping_city: 'Tanger', total: 240, status: 'delivered', tracking_number: 'S6AA79F4A', created_at: '2025-11-24T10:00:00', order_items: [{ product_name: 'Amber Nights', quantity: 2, unit_price: 120 }] },
        ];

        const demoProducts = [
            { id: '1', sku: 'PARFUM-001', name: 'Parfum Royal Oud', price: 150, stock: 45, category: { name: 'Homme' } },
            { id: '2', sku: 'PARFUM-002', name: 'Essence de Rose', price: 200, stock: 32, category: { name: 'Femme' } },
            { id: '3', sku: 'PARFUM-003', name: 'Amber Nights', price: 120, stock: 28, category: { name: 'Unisexe' } },
            { id: '4', sku: 'PARFUM-004', name: 'Musk Premium', price: 180, stock: 15, category: { name: 'Homme' } },
            { id: '5', sku: 'COSM-001', name: 'Cr√®me Hydratante', price: 89, stock: 60, category: { name: 'Cosm√©tique' } },
        ];

        const demoLabels = [
            { id: '1', label_number: 'BL682045', carrier: 'digylog', orders_count: 4, total_amount: 1200, status: 'completed', payment_status: 'unpaid' },
            { id: '2', label_number: 'BL682007', carrier: 'digylog', orders_count: 6, total_amount: 1800, status: 'completed', payment_status: 'paid' },
        ];

        // =============================================
        // INITIALIZATION
        // =============================================
        document.addEventListener('DOMContentLoaded', function() {
            loadSavedConfig();
            
            if (CONFIG.SUPABASE_URL && CONFIG.SUPABASE_ANON_KEY) {
                document.getElementById('config-modal').classList.add('hidden');
                initSupabase();
            }
            
            updateDate();
        });

        function loadSavedConfig() {
            CONFIG.SUPABASE_URL = localStorage.getItem('hichoux_supabase_url') || '';
            CONFIG.SUPABASE_ANON_KEY = localStorage.getItem('hichoux_supabase_key') || '';
            CONFIG.GOOGLE_SCRIPT_URL = localStorage.getItem('hichoux_gas_url') || '';
            
            document.getElementById('config-url').value = CONFIG.SUPABASE_URL;
            document.getElementById('config-key').value = CONFIG.SUPABASE_ANON_KEY;
            document.getElementById('config-gas').value = CONFIG.GOOGLE_SCRIPT_URL;
        }

        function saveConfig() {
            const url = document.getElementById('config-url').value.trim();
            const key = document.getElementById('config-key').value.trim();
            const gas = document.getElementById('config-gas').value.trim();

            if (!url || !key) {
                showToast('URL et Anon Key requis', 'error');
                return;
            }

            localStorage.setItem('hichoux_supabase_url', url);
            localStorage.setItem('hichoux_supabase_key', key);
            localStorage.setItem('hichoux_gas_url', gas);

            CONFIG.SUPABASE_URL = url;
            CONFIG.SUPABASE_ANON_KEY = key;
            CONFIG.GOOGLE_SCRIPT_URL = gas;

            document.getElementById('config-modal').classList.add('hidden');
            initSupabase();
            showToast('Configuration sauvegard√©e!');
        }

        function skipConfig() {
            document.getElementById('config-modal').classList.add('hidden');
            useDemoMode();
        }

        function useDemoMode() {
            orders = [...demoOrders];
            products = [...demoProducts];
            shippingLabels = [...demoLabels];
            
            document.getElementById('connection-status').innerHTML = '<span class="text-gray-400">‚óè Mode Demo</span>';
            
            updateUI();
            showToast('Mode Demo activ√©', 'info');
        }

        async function initSupabase() {
            try {
                supabaseClient = supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY);
                document.getElementById('connection-status').innerHTML = '<span class="text-green-500">‚óè Connect√©</span>';
                
                await loadDataFromSupabase();
                updateUI();
                showToast('Connect√© √† Supabase!');
            } catch (error) {
                console.error('Supabase error:', error);
                showToast('Erreur de connexion', 'error');
                useDemoMode();
            }
        }

        async function loadDataFromSupabase() {
            try {
                const [ordersRes, productsRes] = await Promise.all([
                    supabaseClient.from('orders').select('*, order_items(*)').order('created_at', { ascending: false }),
                    supabaseClient.from('products').select('*, category:categories(id, name)').eq('is_active', true)
                ]);

                if (ordersRes.data) orders = ordersRes.data;
                if (productsRes.data) products = productsRes.data;
            } catch (error) {
                console.error('Load error:', error);
                useDemoMode();
            }
        }

        function refreshData() {
            if (supabaseClient) {
                loadDataFromSupabase().then(() => {
                    updateUI();
                    showToast('Donn√©es actualis√©es');
                });
            } else {
                showToast('Mode Demo - pas de donn√©es √† actualiser', 'info');
            }
        }

        // =============================================
        // UI FUNCTIONS
        // =============================================
        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const colors = { success: 'bg-green-500', error: 'bg-red-500', info: 'bg-blue-500', warning: 'bg-yellow-500' };
            const icons = { success: '‚úì', error: '‚úï', info: '‚Ñπ', warning: '‚ö†' };

            const toast = document.createElement('div');
            toast.className = `toast ${colors[type]} text-white px-6 py-3 rounded-xl shadow-lg flex items-center space-x-2`;
            toast.innerHTML = `<span>${icons[type]}</span><span>${message}</span>`;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function showLoading(text = 'Chargement...') {
            document.getElementById('loading-text').textContent = text;
            document.getElementById('loading-overlay').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
        }

        function updateDate() {
            const el = document.getElementById('current-date');
            if (el) {
                el.textContent = new Date().toLocaleDateString('fr-FR', {
                    weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
                });
            }
        }

        // =============================================
        // NAVIGATION
        // =============================================
        function showPage(pageId) {
            // Hide all pages
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            
            // Show selected page
            const page = document.getElementById('page-' + pageId);
            if (page) {
                page.classList.add('active');
            }

            // Update sidebar
            document.querySelectorAll('.sidebar-item').forEach(s => s.classList.remove('active'));
            const navBtn = document.querySelector(`[data-page="${pageId}"]`);
            if (navBtn) {
                navBtn.classList.add('active');
            }

            // Render page-specific content
            if (pageId === 'confirmation') renderConfirmation();
            if (pageId === 'orders') renderOrdersTable();
            if (pageId === 'products') renderProducts();
            if (pageId === 'shipping') renderShipping();
            if (pageId === 'settings') populateSettings();
        }

        // =============================================
        // UPDATE UI
        // =============================================
        function updateUI() {
            updateStats();
            renderRecentOrders();
            updateBadges();
        }

        function updateStats() {
            const stats = {
                new: orders.filter(o => o.status === 'new').length,
                confirmed: orders.filter(o => o.status === 'confirmed').length,
                shipped: orders.filter(o => o.status === 'shipped').length,
                delivered: orders.filter(o => o.status === 'delivered').length,
                revenue: orders.filter(o => o.status === 'delivered').reduce((s, o) => s + (o.total || 0), 0)
            };

            document.getElementById('stat-new').textContent = stats.new;
            document.getElementById('stat-confirmed').textContent = stats.confirmed;
            document.getElementById('stat-shipped').textContent = stats.shipped;
            document.getElementById('stat-delivered').textContent = stats.delivered;
            document.getElementById('stat-revenue').textContent = stats.revenue + ' ' + CONFIG.CURRENCY;
        }

        function updateBadges() {
            const newCount = orders.filter(o => o.status === 'new').length;
            
            document.querySelectorAll('.badge-orders, .badge-confirmation').forEach(badge => {
                badge.textContent = newCount;
                badge.classList.toggle('hidden', newCount === 0);
            });
        }

        function getStatusBadge(status) {
            const statuses = {
                new: { label: 'Nouvelle', color: 'bg-yellow-100 text-yellow-800' },
                confirmed: { label: 'Confirm√©e', color: 'bg-blue-100 text-blue-800' },
                shipped: { label: 'Exp√©di√©e', color: 'bg-purple-100 text-purple-800' },
                delivered: { label: 'Livr√©e', color: 'bg-green-100 text-green-800' },
                cancelled: { label: 'Annul√©e', color: 'bg-red-100 text-red-800' },
                completed: { label: 'Termin√©', color: 'bg-green-100 text-green-800' },
                unpaid: { label: 'Non pay√©', color: 'bg-red-100 text-red-800' },
                paid: { label: 'Pay√©', color: 'bg-green-100 text-green-800' }
            };
            const config = statuses[status] || { label: status, color: 'bg-gray-100 text-gray-800' };
            return `<span class="px-3 py-1 rounded-full text-xs font-semibold ${config.color}">${config.label}</span>`;
        }

        function formatDate(dateStr) {
            if (!dateStr) return '-';
            return new Date(dateStr).toLocaleDateString('fr-FR', {
                day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit'
            });
        }

        // =============================================
        // RECENT ORDERS (DASHBOARD)
        // =============================================
        function renderRecentOrders() {
            const container = document.getElementById('recent-orders-table');
            if (!container) return;

            container.innerHTML = orders.slice(0, 5).map(o => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4">
                        <p class="font-medium">${o.order_number || o.id}</p>
                        <p class="text-xs text-gray-500">${formatDate(o.created_at)}</p>
                    </td>
                    <td class="px-6 py-4">${o.customer_name}</td>
                    <td class="px-6 py-4">${o.shipping_city}</td>
                    <td class="px-6 py-4 font-semibold">${o.total} ${CONFIG.CURRENCY}</td>
                    <td class="px-6 py-4">${getStatusBadge(o.status)}</td>
                    <td class="px-6 py-4">
                        <button onclick="openOrderModal('${o.id}')" class="text-blue-600 hover:underline text-sm">Voir</button>
                    </td>
                </tr>
            `).join('');
        }

        // =============================================
        // ORDERS TABLE
        // =============================================
        function renderOrdersTable() {
            filterOrders();
        }

        function filterOrders() {
            const search = (document.getElementById('search-orders')?.value || '').toLowerCase();
            const status = document.getElementById('filter-status')?.value || 'all';

            const filtered = orders.filter(o => {
                const matchSearch = !search ||
                    o.customer_name?.toLowerCase().includes(search) ||
                    o.customer_phone?.includes(search) ||
                    o.order_number?.toLowerCase().includes(search);
                const matchStatus = status === 'all' || o.status === status;
                return matchSearch && matchStatus;
            });

            const container = document.getElementById('orders-table');
            if (!container) return;

            container.innerHTML = filtered.map(o => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4">
                        <p class="font-medium">${o.order_number || o.id}</p>
                        <p class="text-xs text-gray-500">${formatDate(o.created_at)}</p>
                    </td>
                    <td class="px-6 py-4">${o.customer_name}</td>
                    <td class="px-6 py-4">${o.customer_phone}</td>
                    <td class="px-6 py-4">${o.shipping_city}</td>
                    <td class="px-6 py-4 font-semibold">${o.total} ${CONFIG.CURRENCY}</td>
                    <td class="px-6 py-4">${getStatusBadge(o.status)}</td>
                    <td class="px-6 py-4 font-mono text-sm ${o.tracking_number ? 'text-blue-600' : 'text-gray-400'}">${o.tracking_number || '-'}</td>
                    <td class="px-6 py-4">
                        <button onclick="openOrderModal('${o.id}')" class="text-blue-600 hover:underline text-sm">Voir</button>
                    </td>
                </tr>
            `).join('');
        }

        // =============================================
        // CONFIRMATION
        // =============================================
        function renderConfirmation() {
            const pending = orders.filter(o => o.status === 'new');
            document.getElementById('pending-count').textContent = `${pending.length} commandes en attente`;

            const listContainer = document.getElementById('confirmation-list');
            const emptyContainer = document.getElementById('all-confirmed');

            if (pending.length === 0) {
                listContainer.innerHTML = '';
                emptyContainer.classList.remove('hidden');
            } else {
                emptyContainer.classList.add('hidden');
                listContainer.innerHTML = pending.map(o => `
                    <div class="bg-white rounded-2xl p-6 shadow-sm border">
                        <div class="flex flex-col lg:flex-row lg:items-start lg:justify-between gap-6">
                            <div class="flex-1">
                                <div class="flex flex-wrap items-center gap-3 mb-4">
                                    <span class="text-lg font-bold">${o.order_number || o.id}</span>
                                    ${getStatusBadge(o.status)}
                                    ${o.notes ? `<span class="px-2 py-1 bg-yellow-100 text-yellow-800 text-xs rounded-full">${o.notes}</span>` : ''}
                                </div>
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                                    <div><p class="text-xs text-gray-500">Client</p><p class="font-medium">${o.customer_name}</p></div>
                                    <div><p class="text-xs text-gray-500">T√©l√©phone</p><p class="font-medium">${o.customer_phone}</p></div>
                                    <div><p class="text-xs text-gray-500">Ville</p><p class="font-medium">${o.shipping_city}</p></div>
                                    <div><p class="text-xs text-gray-500">Total</p><p class="font-bold text-blue-600 text-lg">${o.total} ${CONFIG.CURRENCY}</p></div>
                                </div>
                                <p class="text-sm text-gray-600 mb-3">${o.shipping_address}</p>
                                <div class="flex flex-wrap gap-2">
                                    ${(o.order_items || []).map(item => `
                                        <span class="px-2 py-1 bg-gray-100 rounded text-xs">${item.product_name} x${item.quantity}</span>
                                    `).join('')}
                                </div>
                            </div>
                            <div class="flex flex-row lg:flex-col gap-2">
                                <a href="tel:${o.customer_phone}" class="px-4 py-2 bg-blue-600 text-white rounded-xl text-center hover:bg-blue-700 transition text-sm font-medium">üìû Appeler</a>
                                <a href="https://wa.me/${o.customer_phone.replace(/^0/, '212')}?text=${encodeURIComponent('Bonjour ' + o.customer_name + ', concernant votre commande ' + (o.order_number || o.id))}" target="_blank" class="px-4 py-2 bg-green-500 text-white rounded-xl text-center hover:bg-green-600 transition text-sm font-medium">üí¨ WhatsApp</a>
                                <button onclick="confirmOrder('${o.id}')" class="px-4 py-2 bg-emerald-600 text-white rounded-xl hover:bg-emerald-700 transition text-sm font-medium">‚úì Confirmer</button>
                                <button onclick="cancelOrder('${o.id}')" class="px-4 py-2 bg-red-500 text-white rounded-xl hover:bg-red-600 transition text-sm font-medium">‚úï Annuler</button>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
        }

        async function confirmOrder(id) {
            showLoading('Confirmation...');

            const order = orders.find(o => o.id === id);
            if (!order) { hideLoading(); return; }

            if (supabaseClient) {
                try {
                    await supabaseClient.from('orders').update({
                        status: 'confirmed',
                        confirmed_at: new Date().toISOString()
                    }).eq('id', id);
                } catch (e) { console.error(e); }
            }

            order.status = 'confirmed';
            order.confirmed_at = new Date().toISOString();

            if (CONFIG.GOOGLE_SCRIPT_URL) {
                try {
                    await fetch(CONFIG.GOOGLE_SCRIPT_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        body: JSON.stringify({
                            action: 'addOrder',
                            order: {
                                orderRef: order.order_number,
                                name: order.customer_name,
                                phone: order.customer_phone,
                                address: order.shipping_address,
                                city: order.shipping_city,
                                codAmount: order.total,
                                status: 'Confirmed'
                            }
                        })
                    });
                } catch (e) { console.error(e); }
            }

            hideLoading();
            showToast(`Commande ${order.order_number || id} confirm√©e!`);
            updateUI();
            renderConfirmation();
        }

        async function cancelOrder(id) {
            const reason = prompt('Raison de l\'annulation (optionnel):');
            showLoading('Annulation...');

            if (supabaseClient) {
                try {
                    await supabaseClient.from('orders').update({
                        status: 'cancelled',
                        cancelled_at: new Date().toISOString(),
                        cancelled_reason: reason
                    }).eq('id', id);
                } catch (e) { console.error(e); }
            }

            const order = orders.find(o => o.id === id);
            if (order) order.status = 'cancelled';

            hideLoading();
            showToast('Commande annul√©e', 'warning');
            updateUI();
            renderConfirmation();
        }

        // =============================================
        // ORDER MODAL
        // =============================================
        function openOrderModal(id) {
            const order = orders.find(o => o.id === id);
            if (!order) return;

            document.getElementById('modal-order-id').textContent = order.order_number || order.id;

            document.getElementById('modal-content').innerHTML = `
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div><p class="text-xs text-gray-500">Client</p><p class="font-semibold">${order.customer_name}</p></div>
                    <div><p class="text-xs text-gray-500">T√©l√©phone</p><p class="font-semibold">${order.customer_phone}</p></div>
                    <div><p class="text-xs text-gray-500">Ville</p><p class="font-semibold">${order.shipping_city}</p></div>
                    <div><p class="text-xs text-gray-500">Total</p><p class="font-bold text-blue-600 text-xl">${order.total} ${CONFIG.CURRENCY}</p></div>
                </div>
                <div class="mb-6">
                    <p class="text-xs text-gray-500 mb-1">Adresse</p>
                    <p class="bg-gray-50 p-3 rounded-lg">${order.shipping_address}</p>
                </div>
                <div class="mb-6">
                    <p class="text-xs text-gray-500 mb-1">Statut</p>
                    ${getStatusBadge(order.status)}
                </div>
                ${order.tracking_number ? `<div class="mb-6"><p class="text-xs text-gray-500 mb-1">Tracking</p><p class="font-mono text-blue-600">${order.tracking_number}</p></div>` : ''}
                <div>
                    <p class="text-xs text-gray-500 mb-2">Produits</p>
                    <div class="space-y-2">
                        ${(order.order_items || []).map(item => `
                            <div class="flex justify-between bg-gray-50 p-3 rounded-lg">
                                <span>${item.product_name} x${item.quantity}</span>
                                <span class="font-semibold">${item.unit_price * item.quantity} ${CONFIG.CURRENCY}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;

            let actions = `
                <a href="tel:${order.customer_phone}" class="px-4 py-2 bg-blue-600 text-white rounded-xl hover:bg-blue-700 transition text-sm font-medium">üìû Appeler</a>
                <a href="https://wa.me/${order.customer_phone.replace(/^0/, '212')}" target="_blank" class="px-4 py-2 bg-green-500 text-white rounded-xl hover:bg-green-600 transition text-sm font-medium">üí¨ WhatsApp</a>
            `;

            if (order.status === 'new') {
                actions += `
                    <button onclick="confirmOrder('${order.id}'); closeOrderModal();" class="px-4 py-2 bg-emerald-600 text-white rounded-xl hover:bg-emerald-700 transition text-sm font-medium">‚úì Confirmer</button>
                    <button onclick="cancelOrder('${order.id}'); closeOrderModal();" class="px-4 py-2 bg-red-500 text-white rounded-xl hover:bg-red-600 transition text-sm font-medium">‚úï Annuler</button>
                `;
            }

            document.getElementById('modal-actions').innerHTML = actions;
            document.getElementById('order-modal').classList.remove('hidden');
        }

        function closeOrderModal() {
            document.getElementById('order-modal').classList.add('hidden');
        }

        // =============================================
        // SHIPPING
        // =============================================
        function renderShipping() {
            const container = document.getElementById('shipping-table');
            if (!container) return;

            container.innerHTML = shippingLabels.map(l => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 font-medium">${l.label_number}</td>
                    <td class="px-6 py-4"><span class="px-2 py-1 bg-purple-100 text-purple-700 rounded-full text-xs capitalize">${l.carrier}</span></td>
                    <td class="px-6 py-4">${l.orders_count}</td>
                    <td class="px-6 py-4 font-semibold">${l.total_amount} ${CONFIG.CURRENCY}</td>
                    <td class="px-6 py-4">${getStatusBadge(l.status)}</td>
                    <td class="px-6 py-4">${getStatusBadge(l.payment_status)}</td>
                    <td class="px-6 py-4"><button class="p-2 hover:bg-gray-100 rounded-lg transition">‚¨áÔ∏è</button></td>
                </tr>
            `).join('');
        }

        async function createShippingLabel() {
            const confirmed = orders.filter(o => o.status === 'confirmed');

            if (confirmed.length === 0) {
                showToast('Aucune commande confirm√©e', 'warning');
                return;
            }

            showLoading('Cr√©ation du bordereau...');
            await new Promise(r => setTimeout(r, 1500));

            for (const order of confirmed) {
                order.status = 'shipped';
                order.tracking_number = 'S' + Math.random().toString(36).substr(2, 8).toUpperCase();

                if (supabaseClient) {
                    try {
                        await supabaseClient.from('orders').update({
                            status: 'shipped',
                            shipped_at: new Date().toISOString()
                        }).eq('id', order.id);
                    } catch (e) { console.error(e); }
                }
            }

            const newLabel = {
                id: Date.now().toString(),
                label_number: 'BL' + Date.now().toString().slice(-6),
                carrier: 'digylog',
                orders_count: confirmed.length,
                total_amount: confirmed.reduce((s, o) => s + o.total, 0),
                status: 'completed',
                payment_status: 'unpaid'
            };

            shippingLabels.unshift(newLabel);

            hideLoading();
            showToast(`Bordereau cr√©√©: ${newLabel.label_number}`);
            updateUI();
            renderShipping();
        }

        // =============================================
        // PRODUCTS
        // =============================================
        function renderProducts() {
            document.getElementById('products-count').textContent = `${products.length} produits`;

            const container = document.getElementById('products-table');
            if (!container) return;

            container.innerHTML = products.map(p => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 font-medium">${p.name}</td>
                    <td class="px-6 py-4 text-gray-600 font-mono text-sm">${p.sku}</td>
                    <td class="px-6 py-4"><span class="px-2 py-1 bg-gray-100 rounded-full text-xs">${p.category?.name || '-'}</span></td>
                    <td class="px-6 py-4 font-semibold">${p.price} ${CONFIG.CURRENCY}</td>
                    <td class="px-6 py-4 ${p.stock < 20 ? 'text-red-600 font-semibold' : 'text-green-600'}">${p.stock}</td>
                    <td class="px-6 py-4"><button class="text-blue-600 hover:underline text-sm">Modifier</button></td>
                </tr>
            `).join('');
        }

        // =============================================
        // SETTINGS
        // =============================================
        function populateSettings() {
            document.getElementById('settings-supabase-url').value = CONFIG.SUPABASE_URL || 'Non configur√©';

            const statusEl = document.getElementById('settings-supabase-status');
            if (supabaseClient) {
                statusEl.textContent = '‚úì Connect√©';
                statusEl.className = 'px-4 py-2.5 bg-green-100 text-green-700 rounded-xl';
            } else {
                statusEl.textContent = '‚úï Non connect√©';
                statusEl.className = 'px-4 py-2.5 bg-red-100 text-red-700 rounded-xl';
            }
        }

        function saveSettings() {
            showToast('Param√®tres sauvegard√©s!');
        }

        async function syncToGoogleSheet() {
            if (!CONFIG.GOOGLE_SCRIPT_URL) {
                showToast('URL Google Apps Script non configur√©e', 'warning');
                return;
            }

            const confirmed = orders.filter(o => o.status === 'confirmed');
            if (confirmed.length === 0) {
                showToast('Aucune commande √† synchroniser', 'info');
                return;
            }

            showLoading('Synchronisation...');

            try {
                await fetch(CONFIG.GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify({
                        action: 'addOrders',
                        orders: confirmed.map(o => ({
                            orderRef: o.order_number,
                            name: o.customer_name,
                            phone: o.customer_phone,
                            address: o.shipping_address,
                            city: o.shipping_city,
                            codAmount: o.total,
                            status: 'Confirmed'
                        }))
                    })
                });

                document.getElementById('last-sync').textContent = 'Last sync: ' + new Date().toLocaleString('fr-FR');
                showToast(`${confirmed.length} commandes synchronis√©es`);
            } catch (e) {
                showToast('Erreur de synchronisation', 'error');
            }

            hideLoading();
        }

        // Close modal on escape
        document.addEventListener('keydown', e => {
            if (e.key === 'Escape') closeOrderModal();
        });

        // Close modal on outside click
        document.getElementById('order-modal')?.addEventListener('click', function(e) {
            if (e.target === this) closeOrderModal();
        });
    </script>
</body>
</html>
